
image: Visual Studio 2022

# Ставим JDK 11 (Temurin) на агент
install:
  - choco install temurin11 -y --no-progress
  - setx JAVA_HOME "C:\Program Files\Eclipse Adoptium\jdk-11"
  - set PATH=%JAVA_HOME%\bin;%PATH%
  - where java
  - java -version
  - gradlew.bat --version

build_script:
  # Собираем тесты (ваш проект — это тесты; SUT уже в artifacts)
  - gradlew.bat clean testClasses --info

  # Запускаем SUT из корня репозитория: artifacts\app-mbank.jar
  - ps: |
      $jar = Join-Path $env:APPVEYOR_BUILD_FOLDER "artifacts\app-mbank.jar"
      if (-not (Test-Path $jar)) { Write-Host "ERROR: no SUT jar at $jar"; exit 1 }
      $p = Start-Process -FilePath "java" -ArgumentList @("-jar", $jar) -NoNewWindow -PassThru
      $p.Id | Set-Content -Path "server_pid.txt" -Encoding ASCII
      Write-Host "SUT started, PID=$($p.Id)"

  # Ждём, пока SUT начнет слушать порт 9999 (макс. 45 c)
  - ps: |
      $port=9999; $max=45; $i=0
      Write-Host "Waiting for http://localhost:$port ..."
      while ($i -lt $max) {
        if ((Test-NetConnection -ComputerName 'localhost' -Port $port -WarningAction SilentlyContinue).TcpTestSucceeded) {
          Write-Host "SUT is UP on $port"; break
        }
        Start-Sleep -Seconds 1; $i++
      }
      if ($i -ge $max) { Write-Host "ERROR: SUT didn't start in ${max}s"; exit 1 }

  # Запускаем тесты
  - gradlew.bat test --info

  # Останавливаем SUT
  - ps: |
      if (Test-Path "server_pid.txt") {
        $pid = Get-Content "server_pid.txt"
        Write-Host "Stopping SUT PID=$pid"
        Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
      }

artifacts:
  - path: artifacts\app-mbank.jar
    name: app-mbank

branches:
  only:
    - main


    
