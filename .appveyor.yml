image: Visual Studio 2022

environment:
  matrix:
    - JDK_VERSION: 8

# 1) Ставим JDK 8 на агенте и проверяем версии
install:
  - choco install openjdk8 -y
  - refreshenv
  - java -version
  - where java
  - gradlew.bat --version

# 2) Сборка и тестирование
build_script:
  # --- СБОРКА ТОЛЬКО JAR (без тестов!), чтобы успеть поднять SUT ---
  - gradlew.bat clean assemble --info

  # Папка для учебного jar в формате задания
  - if not exist src\artifacts mkdir src\artifacts
  - copy /Y build\libs\*.jar src\artifacts\app-mbank.jar

  # --- ЗАПУСК SUT (app-mbank.jar) В ФОНЕ + ЛОГИ ---
  - ps: |
      $jar = Join-Path $env:APPVEYOR_BUILD_FOLDER "src\artifacts\app-mbank.jar"
      if (-not (Test-Path $jar)) {
        Write-Host "ERROR: jar not found at $jar"; exit 1
      }
      $stdout = Join-Path $env:APPVEYOR_BUILD_FOLDER "sut_stdout.log"
      $stderr = Join-Path $env:APPVEYOR_BUILD_FOLDER "sut_stderr.log"
      Write-Host "Starting SUT: $jar"
      $p = Start-Process -FilePath "java" -ArgumentList "-jar", ""$jar"" -NoNewWindow -PassThru -RedirectStandardOutput $stdout -RedirectStandardError $stderr
      $pid = $p.Id
      Set-Content -Path server_pid.txt -Value $pid
      Write-Host "SUT started, PID = $pid"

  # --- ОЖИДАНИЕ ГОТОВНОСТИ ПОРТА 9999 (макс. 45 сек) ---
  - ps: |
      $port = 9999
      $maxWait = 45
      $i = 0
      Write-Host "Waiting for SUT on http://localhost:$port (timeout ${maxWait}s)..."
      while ($i -lt $maxWait) {
        $ok = (Test-NetConnection -ComputerName 'localhost' -Port $port -WarningAction SilentlyContinue).TcpTestSucceeded
        if ($ok) { Write-Host "SUT is up on port $port"; break }
        Start-Sleep -Seconds 1; $i++
      }
      if ($i -ge $maxWait) {
        Write-Host "ERROR: SUT did not start within ${maxWait}s"
        if (Test-Path "sut_stderr.log") { Write-Host "----- SUT STDERR (tail) -----"; Get-Content sut_stderr.log -Tail 200 | Write-Host }
        if (Test-Path "sut_stdout.log") { Write-Host "----- SUT STDOUT (tail) -----"; Get-Content sut_stdout.log -Tail 200 | Write-Host }
        exit 1
      }

  # --- ЗАПУСК ТЕСТОВ (теперь SUT точно поднят) ---
  - gradlew.bat test --info

  # --- ОСТАНОВКА SUT ПОСЛЕ ТЕСТОВ ---
  - ps: |
      if (Test-Path server_pid.txt) {
        try {
          $pid = Get-Content server_pid.txt
          Write-Host "Stopping SUT, PID=$pid"
          Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
          Remove-Item server_pid.txt -ErrorAction SilentlyContinue
          Write-Host "SUT stopped"
        } catch {
          Write-Host "WARNING: could not stop SUT: $_"
        }
      } else {
        Write-Host "No server_pid.txt found (SUT already stopped?)"
      }

# 3) Публикуем учебный jar как артефакт
artifacts:
  - path: src\artifacts\app-mbank.jar
    name: app-mbank

branches:
  only:
    - main